import gzip
import tarfile
import psycopg2
import argparse


def hazard_restore(conn, tar, chatty=False):
    """
    Import a tar file generated by the HazardDumper.

    :param conn: the psycopg2 connection to the db
    :param tar: the pathname to the tarfile
    :returns: the total number of imported rows
    """
    curs = conn.cursor()
    tf = tarfile.open(tar)
    n = 0
    try:
        for line in tf.extractfile('hazard_calculation/FILENAMES.txt'):
            fname = line.rstrip()
            tname = fname[:-7]  # strip .csv.gz
            fileobj = tf.extractfile('hazard_calculation/%s' % fname)
            with gzip.GzipFile(fname, fileobj=fileobj) as f:
                if chatty:
                    print 'Importing %s...' % fname
                curs.copy_from(f, tname)
                n += curs.rowcount
    except:
        conn.rollback()
        raise
    else:
        conn.commit()
    return n

if __name__ == '__main__':
    p = argparse.ArgumentParser()
    p.add_argument('tarfile')
    p.add_argument('host', nargs='?', default='localhost')
    p.add_argument('dbname', nargs='?', default='openquake')
    p.add_argument('user', nargs='?', default='oq_admin')
    p.add_argument('password', nargs='?', default='')
    arg = p.parse_args()
    conn = psycopg2.connect(host=arg.host, dbname=arg.dbname,
                            username=arg.user, password=arg.password)
    print 'Imported %d rows', hazard_restore(conn, arg.tarfile, chatty=True)
