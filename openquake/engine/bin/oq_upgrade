#!/usr/bin/env python
import sys
import importlib
from openquake.commonlib import sap
from openquake.engine.db import util


def main(command='upgrade', uri='oq_admin:openquake@localhost/openquake',
         upgrades='openquake.engine.db.schema.upgrades'):
    """
    A script to manage database migrations.
    """
    conn = util.Connection(uri).open()
    try:
        # upgrader is an UpgradeManager instance defined in the __init__.py
        upgrader = importlib.import_module(upgrades).upgrader
    except ImportError:
        sys.exit('Could not import %s (not in the PYTHONPATH?)' % upgrades)
    if not upgrader.read_scripts():
        sys.exit('The upgrade_dir does not contain scripts matching '
                 'the pattern %s' % upgrader.pattern)
    with conn.begin():
        return getattr(upgrader, command)(conn)


if __name__ == '__main__':
    p = sap.Parser(main)
    p.arg('command', 'command to perform', choices=[
            'init_db', 'install_versioning', 'upgrade'])
    p.arg('uri', 'database URI (driver://usr:pwd@host/db)')
    p.arg('upgrades', 'package where the upgrades scripts are stored')
    p.callfunc()
