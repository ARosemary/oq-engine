Release notes for the OpenQuake Engine, version 2.8
===================================================

This release is dedicated to the disaggregation calculator. Several
changes and improvements were implemented and now the calculator is
substantially faster than before.

Nearly 100 pull requests were closed. For the complete list of
changes, please see the changelog:
https://github.com/gem/oq-engine/blob/engine-2.7/debian/changelog

Disaggregation
--------------

We changed the algorithm for building the disaggregation bins. The new
algorithm is simpler and depends directly from the integration
distance. The big advantage compared to the past algorithm is that now
the bins are always the same across different realizations, therefore
it will be possible in the future to implement statistical
disaggregation outputs, like a mean disaggregation matrix.  Moreover,
thanks to the new algorithm, performing a classical calculation when
the flag `iml_disagg` is set in the job.ini file, has become redundant
and so such step has been removed.  If `iml_disagg` is given, forbid
`intensity_measure_types_and_levels Add a check for `poes_disagg` too
big Optimized disaggregation with `iml_disagg` Now if one or more of
the parameters 'mag_bin_width', 'distance_bin_width',
'coordinate_bin_width', 'num_epsilon_bins' is missing in the job.ini
file an early error is raised.
Ordered the TRT bins lexicographically
Made the disagg matrices 5-dimensional internally
Removed `gsim.disaggregate_poe` 
Added a check on poe_agg

More on hazard
--------------

- Implemented piecewise magnitude-distance filtering

- Added a check for 
`Missing source_model_logic_tree in job.ini or missing --hc option`

- added `optimize_same_id_sources`
- a note on disaggregation by source (PmapGetter)

- oq extract hazard/rlzs
- changed the management of the MultiPointSources
Optimized the sending of the sources in the classical calculator
SGS model

Risk
----

Fixes to gmf_ebrisk and to the input GMFs file
Improved the error message if the user forgets both sites and sites.csv
Made number_of_ground_motion fields optional again in all scenario calculators
Exposed avg_losses for classical_risk 
Exposing `loss_curves-stats` and `loss_maps-stats` as engine outputs
Fixed oq export loss_curves
Improved the error message if the user specifies a non-existing file in the job.ini ('does not exist or is not a file')
Better error message if the user sets a wrong site_id in the sites.csv file

WebUI/API
----------

Now the WebUI starts jobs in separate processes
Rewritten the WebUI tests to use Django

oq commands
---------------

`oq abort`
`oq show` shows the other users too
`oq zip`

Infrastructure
--------------

- oq dbserver stop also stops the zmq workers
- change how the weigths are managed in sampling;
- hugely optimized the logic tree sampling procedure (India model)
- restrict rlzs_assoc by setting smlt_path; built it only once; 
- improved venv/configuration
- setproctitle in oq-dbserver

- oq engine --run archive.zip now works;
- Python 3 installers

Deprecations
------------

Deprecate the .geojson exporters 
Removed deprecated scenario_damage outputs 'dmg_by_tag', 'dmg_total',
'losses_by_tag', 'losses_total'

losses_by_tag, losses_total in scenario_risk too and ebr too

Removed obsolete parameter loss_curve_resolution 

Other
-----

A substantial amount of work went into testing and packaging.
Now we have automated tests for macOS both for Python 2.7 and Python 3.5.
Moreover celery is now tested on Linux both with Python 2.7 and Python 3.5.
The Hazard Modeller's Toolkit (HMTK) has been brought under continuous integration
(CI).

As usual, the internal format in the datastore has changed, so you cannot
read calculations generated by previous versions of the engine.
Now the name of the Python processes spawned by the engine is `oq-worker`:
this is convenient, both for visualization/listing purposes and also for
killing all the engine processes at once.

We fixed an error in Windows caused by a random seed being a numpy.uint32
integer instead of a Python integer.

[Our roadmap for abandoning Python 2](https://github.com/gem/oq-engine/issues/2803) 
has been updated. In short, we will not abandon it until the QGIS plugin
is ported to Python 3 and therefore we are waiting for QGIS 3.0 to become
stable.
